document.addEventListener('DOMContentLoaded', () => {
  const NOVEL = {
    title: "Bucin: Surat Cinta yang Tersimpan",
    chapters: [
      {
        title: "Prolog — pertemuan pertama",
        content: `malam itu, kota tampak tenang setelah hujan yang baru saja reda. Langit berwarna keemasan, dan aspal di sepanjang jalan masih basah, memantulkan cahaya matahari yang mulai tenggelam
,Beberapa menit kemudian, Caca muncul dari arah seberang jalan,dia seyum yang sangat manis dan matanya yang bersinar seakan menandai bahwa ia tahu ada sesuatu yang istimewa akan terjadi.
Ketika mereka berdiri berhadap-hadapan, Bara menyerahkan bunga itu,bunga itu nampak segar dan harum seolah membawa energi hangat di tengah cahaya senja.
Tanpa menunggu lama, ia mengulurkan kotak kecil yang rapi — hadiah sederhana namun penuh makna, dibungkus dengan kertas cokelat lembut.
Caca menerima keduanya dengan senyum manis yang membuat jantung Bara terasa ringan. Tidak ada kata, hanya tatapan dan kehangatan yang terpancar. Di momen itu, dunia di sekitar mereka seakan berhenti sejenak.

Mereka berdiri di pinggir jalan, dikelilingi cahaya bulan dan bintang, dan Bara menatap Caca dengan perasaan yang belum sempat ia ungkapkan dengan kata-kata: pertemuan ini, sederhana tapi begitu sempurna, adalah awal dari sesuatu yang akan tumbuh perlahan, namun pasti.

Caca menatap bunga dan hadiah itu, merasakan hangatnya ketulusan yang datang begitu saja, dan dalam hati kecilnya ia tahu, ini bukan pertemuan biasa. Ini adalah awal dari cerita yang akan mereka jalani bersama — manis, bahagia, dan penuh rasa syukur atas kebetulan kecil yang membawa mereka bertemu.`,
        image: "WhatsApp Image 2025-11-04 at 13.20.28.jpeg"
      },
      {
        title: "Bab 1: Hari Hari Yang Hangat",
        content: `Setelah pertemuan pertama yang manis di pinggir jalan, Bara dan Caca mulai terbiasa dengan kehadiran satu sama lain, meskipun hanya lewat senyum dan sapaan singkat di awal. Tidak ada kata-kata berlebihan, hanya perhatian kecil yang muncul secara alami
Bara membawa bunga atau hadiah kecil sesekali, selalu tanpa alasan yang besar, hanya untuk melihat senyum Caca yang hangat. Caca, di sisi lain, menemukan kenyamanan dari ketulusan Bara yang sederhana, dan setiap kali mereka bertemu, hari-harinya terasa lebih ringan
Mereka mulai saling mengenal tanpa terburu-buru.Hari-hari itu terasa ringan, penuh tawa yang muncul tanpa alasan, dan kehangatan yang terus bertambah dari pertemuan sederhana mereka. Tanpa sadar, kedua hati itu mulai saling terbiasa, saling menunggu momen-momen kecil yang seakan hanya mereka yang mengerti.

Bara dan Caca belajar bahwa cinta bisa hadir tanpa drama besar, tanpa kata-kata megah. Cinta bisa sederhana — seperti bunga yang diberikan Bara, atau senyum hangat Caca saat menerima perhatian kecil. Dan di setiap langkah sore itu, keduanya merasakan bahwa awal cerita ini, walau sederhana, adalah awal yang paling indah.`,
        image: "p.jpg"
      },
      {
        title: "Bab 2: Hari-Hari yang Penuh Kebahagiaan",
        content: `Hari-hari Bara dan Caca kini dipenuhi kebiasaan kecil yang manis. Setiap kali mereka bertemu, senyum yang muncul terasa hangat, seolah memberi energi untuk menghadapi sisa hari. Mereka sering berjalan di pantai yang sama, menikmati udara sore sambil sesekali berhenti melihat daun yang berguguran perlahan.

Bara selalu membawa hal-hal sederhana — bunga, cokelat, atau makanan ringan yang ia tahu akan disukai Caca. Dan setiap pemberian itu selalu diterima dengan senyum yang membuat hati Bara terasa lega dan bahagia.

Caca, sebaliknya, menikmati momen-momen itu tanpa perlu banyak kata. Kehadiran Bara membuatnya merasa nyaman, aman, dan diperhatikan. Setiap langkah mereka di sore yang sama, setiap cahaya matahari yang menembus pepohonan, seakan menjadi saksi bagi cinta kecil yang tumbuh perlahan namun pasti.

Mereka belajar bahwa kebahagiaan bisa datang dari hal-hal sederhana. Tidak perlu janji besar atau kata-kata megah, karena kehangatan dari perhatian kecil dan waktu yang dihabiskan bersama sudah cukup untuk membuat hati terasa penuh.

Dan dalam tiap pertemuan yang terus berulang, Bara dan Caca merasakan bahwa cinta mereka bukan tentang ledakan perasaan, melainkan tentang ketenangan yang membuat hidup terasa lengkap.`,
        image: "WhatsApp Image 2025-11-04 at 13.12.28 (1).jpeg"
      },
      {
        title: "Bab 3: Bertumbuh Bersama",
        content: `Hari-hari berganti, musim berubah, tapi cinta mereka tetap sama — bahkan semakin kuat. Bara dan Caca kini menapaki hidup dengan langkah yang lebih dewasa. Mereka belajar saling memahami, memberi ruang, dan menghargai hal-hal kecil yang sering terlupakan.

Mereka tidak lagi sibuk mencari makna cinta, karena mereka telah menemukannya dalam keseharian yang mereka jalani bersama. Dalam tawa yang muncul di tengah lelah, dalam tatapan yang saling menguatkan, dalam diam yang justru membawa ketenangan.

mereka menyadari bahwa cinta sejati tidak selalu tentang kisah luar biasa, tetapi tentang keberanian untuk terus memilih satu sama lain setiap hari. Tidak peduli seberapa banyak hal berubah, mereka tetap tahu ke mana hati mereka akan pulang.

Cinta mereka tumbuh perlahan, tapi pasti. Seperti tanaman yang dirawat dengan sabar, yang mekar pada waktunya sendiri — indah tanpa harus dipaksa, hangat tanpa harus dijelaskan.`,
        image: "WhatsApp Image 2025-11-04 at 13.12.29.jpeg"
      },
      {
        title: "Epilog — Cinta Yang Menetap",
        content: `Hari Demi Hari berlalu, dan Bara serta Caca tetap bersama, menapaki hidup dengan bahagia dan damai. Tidak ada dramatisasi, tidak ada kata-kata berlebihan. Hanya ketenangan dan kehangatan yang terus mengalir di antara mereka.

Mereka sering duduk di balkon rumah sambil menyesap teh hangat, melihat langit sore yang berubah warna perlahan. Bara masih memberikan bunga sesekali, Caca masih tersenyum hangat setiap kali menerimanya.

Cinta mereka tetap sederhana, namun kokoh. Setiap momen yang mereka lewati bersama menjadi bukti bahwa kebahagiaan sejati tidak selalu harus meledak-ledak. Ia hadir dalam ketulusan, perhatian kecil, dan pilihan untuk tetap bersama setiap hari.

Dan di akhir hari, mereka menyadari bahwa cinta sejati bukan soal bagaimana ia dimulai, tapi bagaimana ia terus tumbuh, bertahan, dan membuat dua hati merasa pulang.`,
        image: "WhatsApp Image 2025-11-04 at 13.12.29 (1).jpeg"
      },
      {
        title: "Kemesraan — Galeri Kenangan",
        // cover image (ditampilkan di featured-image juga) — ganti nama file sesuai yang ada di folder project
        image: "WhatsApp Image 2025-11-03 at 22.54.04.jpeg",
        content: `

          <div class="kemesraan-gallery">
            <!-- Foto -->
            <div class="gallery-item"><img src="WhatsApp Image 2025-11-03 at 22.54.03.jpeg" alt="Foto Kenangan 1"></div>
            <div class="gallery-item"><img src="WhatsApp Image 2025-11-04 at 12.39.21.jpeg" alt="Foto Kenangan 2"></div>
            <div class="gallery-item"><img src="WhatsApp Image 2025-11-04 at 15.12.55.jpeg" alt="Foto Kenangan 3"></div>

            <!-- Video (jangan autoplay saat masuk lightbox, di gallery bisa loop/muted) -->
            <div class="gallery-item">
              <video muted loop playsinline>
                <source src="WhatsApp Video 2025-11-04 at 12.39.21.mp4" type="video/mp4">
              </video>
            </div>

            <!-- Tambah item sesuai nama file di folder project -->
          </div>
        `
      }
    ]
  };

  // dom
  const chapterList = document.getElementById('chapter-list');
  const chapterTitle = document.getElementById('chapter-title');
  const contentArea = document.getElementById('content-area');
  const prevBtn = document.getElementById('prev-chapter');
  const nextBtn = document.getElementById('next-chapter');
  const toggleThemeBtn = document.getElementById('toggle-theme');
  const zoomIn = document.getElementById('zoom-in');
  const zoomOut = document.getElementById('zoom-out');
  const toggleMenu = document.getElementById('toggle-menu');

  let index = 0;
  let fontSize = 16;

  // build list with staggered animation delays
  function buildList(){
    const listWrap = document.createElement('div');
    NOVEL.chapters.forEach((c,i) => {
      const btn = document.createElement('button');
      btn.className = 'chapter-btn';
      btn.innerHTML = `<i class="fas fa-bookmark"></i><div class="title">${c.title}</div>`;
      btn.style.animation = `none`;
      btn.addEventListener('click', ()=> showChapter(i));
      btn.dataset.idx = i;
      listWrap.appendChild(btn);
    });
    // clear existing and append
    chapterList.querySelectorAll('.chapter-btn').forEach(n=>n.remove());
    chapterList.appendChild(listWrap);
    // stagger reveal
    Array.from(listWrap.children).forEach((el, i) => {
      el.style.opacity = 0;
      el.style.transform = 'translateX(-8px)';
      setTimeout(()=>{ el.style.transition = 'opacity .36s var(--transition), transform .36s var(--transition)'; el.style.opacity=1; el.style.transform='none'; }, 90*i);
    });
  }

  // preload image helper
  function preloadImage(src){
    return new Promise((res) => {
      const img = new Image();
      img.onload = () => res(img);
      img.onerror = () => res(null);
      img.src = src;
    });
  }

  // show chapter with animated image swap and content fade
  async function showChapter(i) {
    if (i < 0 || i >= NOVEL.chapters.length) return;
    index = i;
    const ch = NOVEL.chapters[i];
    
    // Update title
    chapterTitle.textContent = ch.title;
    
    // Disable nav while loading
    prevBtn.disabled = true;
    nextBtn.disabled = true;
    
    // Preload and show image
    const featured = contentArea.querySelector('.featured-image img');
    if (featured) {
        featured.classList.add('img-enter');
        featured.src = ch.image;
        featured.onload = () => {
            featured.classList.remove('img-enter');
            featured.classList.add('img-ready');
        };
    }

    // Show content with delay
    setTimeout(() => {
        const newBlock = contentArea.querySelector('.chapter-content');
        if (newBlock) {
            // Gunakan innerHTML untuk menampilkan konten kemesraan
            newBlock.innerHTML = ch.content; // Ganti escapeHtmlToParagraphs dengan innerHTML
        }
        
        // Enable navigation
        prevBtn.disabled = (i === 0);
        nextBtn.disabled = (i === NOVEL.chapters.length - 1);
        
        // Update active chapter in list
        document.querySelectorAll('.chapter-btn').forEach(btn => 
            btn.classList.toggle('active', +btn.dataset.idx === i)
        );
    }, 300);

    // Khusus untuk epilog (chapter terakhir)
    if (i === NOVEL.chapters.length - 1) {
      const ch = NOVEL.chapters[i];
      setTimeout(async () => {
        const newBlock = contentArea.querySelector('.chapter-content');
        if (newBlock && ch.memories) {
          const slideshow = await showMemorySlideshow(ch.memories);
          newBlock.appendChild(slideshow);
        }
      }, 1000);
    }
  }

  // utils: split text into paragraphs for nicer markup
  function escapeHtmlToParagraphs(txt){
    const lines = String(txt).trim().split(/\n+/).map(l => l.trim()).filter(Boolean);
    return lines.map(l => `<p>${escapeHtml(l)}</p>`).join('');
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // progress bar (top of content)
  let progBar = document.createElement('div');
  progBar.className = 'read-progress';
  document.querySelector('.content').appendChild(progBar);
  function updateProgress(){
    const el = contentArea.querySelector('.chapter-content') || contentArea;
    const scrollTop = el.scrollTop || 0;
    const pct = Math.round((scrollTop / Math.max(1, el.scrollHeight - el.clientHeight)) * 100);
    progBar.style.width = pct + '%';
  }

  // theme toggle (persist)
  function applySavedTheme(){
    if (localStorage.getItem('nb-theme') === 'dark'){ document.body.classList.add('dark-mode'); toggleThemeBtn.innerHTML = '<i class="fas fa-sun"></i><span>Siang</span>'; }
  }
  toggleThemeBtn.addEventListener('click', ()=> {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('nb-theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    toggleThemeBtn.innerHTML = document.body.classList.contains('dark-mode') ? '<i class="fas fa-sun"></i><span>Siang</span>' : '<i class="fas fa-moon"></i><span>Malam</span>';
  });

  // zoom
  zoomIn.addEventListener('click', ()=> { fontSize = Math.min(20, fontSize + 1); applyFont(); });
  zoomOut.addEventListener('click', ()=> { fontSize = Math.max(14, fontSize - 1); applyFont(); });
  function applyFont(){ document.querySelectorAll('.chapter-content').forEach(c=> c.style.fontSize = fontSize + 'px'); }

  // prev/next
  prevBtn.addEventListener('click', ()=> showChapter(index - 1));
  nextBtn.addEventListener('click', ()=> showChapter(index + 1));

  // mobile menu
  toggleMenu?.addEventListener('click', ()=> {
    document.querySelector('.chapter-list').classList.toggle('hide');
  });

  // Add lightbox to document
  const lightbox = document.createElement('div');
  lightbox.className = 'lightbox';
  lightbox.innerHTML = `
      <button class="lightbox-close">&times;</button>
      <div class="lightbox-content"></div>
  `;
  document.body.appendChild(lightbox);

  // Handle gallery interactions
  document.addEventListener('click', e => {
      const galleryItem = e.target.closest('.gallery-item');
      if (!galleryItem) return;

      const media = galleryItem.querySelector('img, video');
      if (!media) return;

      const lightbox = document.createElement('div');
      lightbox.className = 'lightbox';
      
      const content = media.cloneNode(true);
      if (content.tagName === 'VIDEO') {
          content.controls = true;
          content.autoplay = true;
      }

      lightbox.innerHTML = `
          <button class="lightbox-close">&times;</button>
          <div class="lightbox-content"></div>
      `;
      lightbox.querySelector('.lightbox-content').appendChild(content);
      
      document.body.appendChild(lightbox);
      setTimeout(() => lightbox.classList.add('active'), 10);

      const closeModal = () => {
          lightbox.classList.remove('active');
          setTimeout(() => lightbox.remove(), 300);
      };

      lightbox.querySelector('.lightbox-close').onclick = closeModal;
      lightbox.onclick = e => {
          if (e.target === lightbox) closeModal();
      };
  });

  // init
  buildList();
  applySavedTheme();
  showChapter(0);
  applyFont();

  // keyboard nav
  document.addEventListener('keydown', (e)=> {
    if (e.key === 'ArrowRight') nextBtn.click();
    if (e.key === 'ArrowLeft') prevBtn.click();
  });
});

// Tambahkan fungsi untuk menampilkan slideshow
async function showMemorySlideshow(memories) {
  const container = document.createElement('div');
  container.className = 'memory-slideshow';
  
  for (let src of memories) {
    const memory = document.createElement('div');
    memory.className = 'memory-item fade-in';
    
    const img = await preloadImage(src);
    if (img) {
      memory.appendChild(img);
      container.appendChild(memory);
      
      // Animasi masuk
      await new Promise(resolve => {
        setTimeout(() => {
          memory.classList.add('show');
          setTimeout(resolve, 2000); // Tampilkan selama 2 detik
        }, 100);
      });
      
      // Animasi keluar
      memory.classList.remove('show');
      await new Promise(resolve => setTimeout(resolve, 500));
    }
  }
  
  return container;
}

// Add this to your DOMContentLoaded event listener
document.addEventListener('click', e => {
    const video = e.target.closest('video');
    if (video) {
        const item = video.closest('.gallery-item');
        if (video.paused) {
            video.play();
            item.classList.add('playing');
        } else {
            video.pause();
            item.classList.remove('playing');
        }
    }
});